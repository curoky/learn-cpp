version: '3'

tasks:
  cmake:
    cmds:
      - cmake -B ./builddir/cmake -S . -G Ninja -DUSED_PM="{{.CLI_ARGS}}"
      - cmake --build ./builddir/cmake # -- -k 100
  conan:
    env:
      CXXFLAGS: -Wno-deprecated-copy -Wno-maybe-uninitialized # just for cppfs
    cmds:
      - conan export package-manager/conan/recipes/cppfs
      - conan export package-manager/conan/recipes/restclient-cpp
      - conan install config/conan/conanfile.txt --output-folder=builddir/conan --install-folder=builddir/conan --build=missing -pr:b=default --profile config/conan/conanrc
      # - >
      #   grep -E 'cmake_find_package=[^\n]*' _conan/conanbuildinfo.txt --color=never |
      #   sed 's/cmake_find_package=//g' |
      #   awk '{printf "find_package(%s)\n", $1}' > config/cmake/conan/deps.cmake
      - find builddir/conan -type f -name "*Config.cmake" | sed 's$builddir/conan/$$g' | sed 's/Config.cmake//g' > builddir/conan/deps-tmp.cmake
      - find builddir/conan -type f -name "*-config.cmake" | sed 's$builddir/conan/$$g' | sed 's/-config.cmake//g' >> builddir/conan/deps-tmp.cmake
      - cat builddir/conan/deps-tmp.cmake | sort -u | awk '{printf "find_package(%s)\n", $1}' > config/cmake/conan/generated-find-pkgs.cmake
      - grep -P 'set\(([-\w]*)_INCLUDE_DIR ' -o -h -r builddir/conan | sed 's/set(//' | sort -u | awk '{printf "include_directories(${%s})\n", $1}' >> config/cmake/conan/generated-find-pkgs.cmake
      - echo 'filegroup(name = "thriftc", srcs = [ "bin/thrift"])' >> builddir/conan/thrift/BUILD
  vcpkg:
    env:
      VCPKG_DEFAULT_TRIPLET: x64-linux-release
      # VCPKG_DEFAULT_TRIPLET: x64-linux-release-static
      VCPKG_OVERLAY_TRIPLETS: build/vcpkg/triplets
    cmds:
      - mkdir -p builddir
      - >
        /opt/vcpkg/vcpkg install --x-use-aria2 2>&1 | tee builddir/vcpkg.log
      # - >
      #   VCPKG_DEFAULT_TRIPLET=x64-linux-release-static /opt/vcpkg/vcpkg install rttr
      #   2>&1 | tee -a builddir/vcpkg.log
      - >
        grep -E "(find_package|set\(|target_link_libraries|find_path|target_include_directories)[^\n]*" --color=never builddir/vcpkg.log |
        sed 's/^\s*//g' |
        sed 's/find_package(Boost/# find_package(Boost/g' |
        sed 's/target/\# target/g' | sort -u > config/cmake/vcpkg/generated-find-pkgs.cmake
  clean:
    cmds:
      - >
        rm -rf target coverage.txt builddir dist
        bazel-bin bazel-my-own-x bazel-out bazel-testlogs
        vcpkg_installed .gradle
